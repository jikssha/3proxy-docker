#!/bin/bash

set -e

#============================================================
# 3proxy æ™ºèƒ½å¯åŠ¨è„šæœ¬
# åŠŸèƒ½ï¼šæ™ºèƒ½ç«¯å£é€‰æ‹©ã€è‡ªåŠ¨å¤šç”¨æˆ·ç”Ÿæˆã€é›¶é…ç½®å¯åŠ¨
#============================================================

CONFIG_FILE="/app/config/3proxy.cfg"
USER_COUNT=5

echo "========================================"
echo "  ðŸš€ 3proxy SOCKS5 ä»£ç†æœåŠ¡å¯åŠ¨ä¸­..."
echo "========================================"

#------------------------------------------------------------
# 1. èŽ·å–æœåŠ¡å™¨å…¬ç½‘ IP
#------------------------------------------------------------
get_public_ip() {
    local ip=""
    
    # å°è¯•æ–¹æ³•1: ipify
    ip=$(curl -s --max-time 5 https://api.ipify.org 2>/dev/null || true)
    if [ -n "$ip" ] && [ "$ip" != "" ]; then
        echo "$ip"
        return
    fi
    
    # å°è¯•æ–¹æ³•2: ifconfig.me
    ip=$(curl -s --max-time 5 https://ifconfig.me 2>/dev/null || true)
    if [ -n "$ip" ] && [ "$ip" != "" ]; then
        echo "$ip"
        return
    fi
    
    # å°è¯•æ–¹æ³•3: icanhazip
    ip=$(curl -s --max-time 5 https://icanhazip.com 2>/dev/null || true)
    if [ -n "$ip" ] && [ "$ip" != "" ]; then
        echo "$ip"
        return
    fi
    
    # å¦‚æžœéƒ½å¤±è´¥ï¼Œè¿”å›žå ä½ç¬¦
    echo "YOUR_SERVER_IP"
}

echo ""
echo "ðŸŒ æ­£åœ¨èŽ·å–æœåŠ¡å™¨å…¬ç½‘ IP..."
SERVER_IP=$(get_public_ip)
echo "âœ… æœåŠ¡å™¨ IP: $SERVER_IP"

#------------------------------------------------------------
# 2. æ™ºèƒ½ç«¯å£é€‰æ‹©é€»è¾‘
#------------------------------------------------------------
if [ -n "$PORT" ]; then
    # Railway/ClawCloud ç­‰å¹³å°ä¼šè®¾ç½® PORT çŽ¯å¢ƒå˜é‡
    PROXY_PORT=$PORT
    echo "âœ… æ£€æµ‹åˆ°å¹³å°ç«¯å£å˜é‡: $PROXY_PORT"
else
    # è‡ªåŠ¨ç”Ÿæˆéšæœºç«¯å£ (30000-50000)
    PROXY_PORT=$((30000 + RANDOM % 20001))
    echo "ðŸŽ² è‡ªåŠ¨ç”Ÿæˆéšæœºç«¯å£: $PROXY_PORT"
fi

#------------------------------------------------------------
# 3. è‡ªåŠ¨ç”Ÿæˆå¤šç”¨æˆ·å‡­è¯
#------------------------------------------------------------
echo ""
echo "ðŸ” æ­£åœ¨ç”Ÿæˆ $USER_COUNT ç»„éšæœºç”¨æˆ·å‡­è¯..."
USERS=()

for i in $(seq 1 $USER_COUNT); do
    # ç”Ÿæˆéšæœºç”¨æˆ·åï¼ˆ8å­—ç¬¦ï¼‰å’Œå¯†ç ï¼ˆ16å­—ç¬¦ï¼‰
    USERNAME=$(openssl rand -hex 4)
    PASSWORD=$(openssl rand -base64 12 | tr -d '/+=' | head -c 16)
    USERS+=("$USERNAME:$PASSWORD")
done

#------------------------------------------------------------
# 4. åŠ¨æ€ç”Ÿæˆ 3proxy é…ç½®æ–‡ä»¶
#------------------------------------------------------------
echo ""
echo "ðŸ“ ç”Ÿæˆé…ç½®æ–‡ä»¶: $CONFIG_FILE"

cat > "$CONFIG_FILE" <<EOF
# 3proxy é…ç½®æ–‡ä»¶ - è‡ªåŠ¨ç”Ÿæˆ

# æ—¥å¿—è¾“å‡ºåˆ° stdoutï¼ˆåˆ©ç”¨ Docker logsï¼‰
log /dev/stdout D
logformat "- +_L%t.%.  %N.%p %E %U %C:%c %R:%r %O %I %h %T"

# DNS æœåŠ¡å™¨
nserver 1.1.1.1
nserver 8.8.8.8
nscache 65536

# è®¾ç½®è¶…æ—¶æ—¶é—´
timeouts 1 5 30 60 180 1800 15 60

# å¤šç”¨æˆ·è®¤è¯
EOF

# æ·»åŠ æ‰€æœ‰ç”¨æˆ·
for user in "${USERS[@]}"; do
    echo "users $user" >> "$CONFIG_FILE"
done

cat >> "$CONFIG_FILE" <<EOF

# è®¿é—®æŽ§åˆ¶
auth strong

# å…è®¸æ‰€æœ‰æº IP
allow *

# SOCKS5 ä»£ç†ç›‘å¬
socks -p$PROXY_PORT
EOF

#------------------------------------------------------------
# 5. æ‰“å°å…³é”®ä¿¡æ¯ Banner
#------------------------------------------------------------
echo ""
echo "========================================"
echo "  âœ¨ 3proxy æœåŠ¡é…ç½®å®Œæˆ"
echo "========================================"
echo ""
echo "ðŸ“Œ ç›‘å¬ç«¯å£: $PROXY_PORT"
echo "ðŸ“Œ æœåŠ¡å™¨IP: $SERVER_IP"
echo ""
echo "ðŸ“‹ èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæ ¼å¼: IP:ç«¯å£:ç”¨æˆ·å:å¯†ç ï¼‰:"
echo "========================================"
for i in "${!USERS[@]}"; do
    USER_INFO="${USERS[$i]}"
    USERNAME="${USER_INFO%%:*}"
    PASSWORD="${USER_INFO##*:}"
    echo "${SERVER_IP}:${PROXY_PORT}:${USERNAME}:${PASSWORD}"
done
echo "========================================"
echo ""
echo "ðŸ’¡ æç¤ºï¼šç›´æŽ¥å¤åˆ¶ä¸Šé¢çš„èŠ‚ç‚¹ä¿¡æ¯åˆ°ä»£ç†å·¥å…·ä¸­ä½¿ç”¨"
echo ""
echo "========================================"
echo "  ðŸŽ¯ æœåŠ¡æ­£åœ¨å¯åŠ¨..."
echo "========================================"
echo ""

#------------------------------------------------------------
# 6. å¯åŠ¨ 3proxyï¼ˆå‰å°è¿è¡Œï¼‰
#------------------------------------------------------------
exec /app/bin/3proxy "$CONFIG_FILE"
